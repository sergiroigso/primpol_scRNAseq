---
title: "Single-Cell RNA-seq Analysis: Spleen and Bone Marrow (WT vs KO)"
author: "Sergi Roig-Soucase"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
    theme: cosmo
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 8,
  cache = FALSE,
  tidy = FALSE
)
```

# 1. Packages needed
```{r load_packages, message=FALSE, warning=FALSE}
# Load required packages
library(Seurat)
library(scDblFinder)
library(SingleR)
library(celldex)
library(SingleCellExperiment)
library(ggplot2)
library(clusterProfiler)
library(org.Mm.eg.db)
library(stringr)
library(dplyr)
library(patchwork)
library(cacoa)
library(ggrepel)
library(RColorBrewer)
library(ggalluvial)
library(fgsea)
library(msigdbr)
library(reshape2)
library(ggalluvial)
cat("All packages loaded successfully!\n")
```

```{r create_directories, include=FALSE}
# Create directory structure for results
if (!dir.exists("results")) {
  dir.create("results", recursive = TRUE, showWarnings = FALSE)
}
if (!dir.exists("results/spleen")) {
  dir.create("results/spleen", recursive = TRUE, showWarnings = FALSE)
}
if (!dir.exists("results")) {
  dir.create("results", recursive = TRUE, showWarnings = FALSE)
}
if (!dir.exists("results/bonemarrow")) {
  dir.create("results/bonemarrow", recursive = TRUE, showWarnings = FALSE)
}
if (!dir.exists("results/cacoa")) {
  dir.create("results/cacoa", recursive = TRUE, showWarnings = FALSE)
}
cat("Directory structure created\n")
```

# 2. Data import
```{r import_data}
cat("\n=== IMPORTING DATA ===\n\n")

# Define sample paths
sample_paths <- list(
  spl_WT = "DATA/WT_SPsample_filtered_feature_bc_matrix.h5",
  spl_KO = "DATA/KO_SP_sample_filtered_feature_bc_matrix.h5",
  bm_WT = "DATA/WT_BM_sample_filtered_feature_bc_matrix.h5",
  bm_KO = "DATA/KO_BM_sample_filtered_feature_bc_matrix.h5"
)

# Import data
spl_WT <- Read10X_h5(sample_paths$spl_WT)
spl_KO <- Read10X_h5(sample_paths$spl_KO)
bm_WT <- Read10X_h5(sample_paths$bm_WT)
bm_KO <- Read10X_h5(sample_paths$bm_KO)

cat("Data imported successfully!\n")
cat(paste0("  Spleen WT: ", ncol(spl_WT), " cells\n"))
cat(paste0("  Spleen KO: ", ncol(spl_KO), " cells\n"))
cat(paste0("  Bone Marrow WT: ", ncol(bm_WT), " cells\n"))
cat(paste0("  Bone Marrow KO: ", ncol(bm_KO), " cells\n"))
```

# 3. QC functions
```{r qc_functions, echo=FALSE}
# =============================================================================
# QC FUNCTIONS
# =============================================================================

plot_qc_overview <- function(seurat_obj, sample_name = "Sample") {
  
  p1 <- VlnPlot(seurat_obj, features = "nFeature_RNA", pt.size = 0) +
    ggtitle(paste0(sample_name, " - Genes")) + NoLegend()
  
  p2 <- VlnPlot(seurat_obj, features = "nCount_RNA", pt.size = 0) +
    ggtitle(paste0(sample_name, " - UMIs")) + NoLegend()
  
  p3 <- VlnPlot(seurat_obj, features = "percent.mt", pt.size = 0) +
    ggtitle(paste0(sample_name, " - MT%")) + NoLegend()
  
  p4 <- VlnPlot(seurat_obj, features = "percent.rb", pt.size = 0) +
    ggtitle(paste0(sample_name, " - Ribo%")) + NoLegend()
  
  combined <- (p1 | p2) / (p3 | p4)
  return(combined)
}

run_scdblfinder <- function(seurat_obj) {
  
  sce <- as.SingleCellExperiment(seurat_obj)
  sce <- scDblFinder(sce)
  seurat_obj$doublet_score <- sce$scDblFinder.score
  seurat_obj$doublet_class <- sce$scDblFinder.class
  
  return(seurat_obj)
}

apply_qc_filtering <- function(seurat_obj, min_features = 500, max_mt = 15) {
  
  n_before <- ncol(seurat_obj)
  
  seurat_obj <- subset(seurat_obj, 
                       subset = nFeature_RNA > min_features & 
                                percent.mt < max_mt &
                                doublet_class == "singlet")
  
  n_after <- ncol(seurat_obj)
  n_removed <- n_before - n_after
  pct_removed <- round(100 * n_removed / n_before, 2)
  
  cat(paste0("  Cells before QC: ", n_before, "\n"))
  cat(paste0("  Cells after QC: ", n_after, "\n"))
  cat(paste0("  Cells removed: ", n_removed, " (", pct_removed, "%)\n\n"))
  
  return(seurat_obj)
}

# =============================================================================
# QC VISUALIZATION FUNCTIONS (NEW!)
# =============================================================================

# -----------------------------------------------------------------------------
# Function: Plot QC histograms
# -----------------------------------------------------------------------------
plot_qc_histograms <- function(seurat_obj, sample_name = "Sample") {
  
  cat(paste0("Creating QC histograms for ", sample_name, "...\n"))
  
  metadata <- seurat_obj@meta.data
  
  # Histogram 1: Total UMI distribution
  p1 <- ggplot(metadata, aes(x = nCount_RNA)) +
    geom_histogram(bins = 50, fill = "#3498db", color = "black", alpha = 0.7) +
    geom_vline(xintercept = median(metadata$nCount_RNA), 
               linetype = "dashed", color = "red", size = 1) +
    scale_x_log10() +
    annotation_logticks(sides = "b") +
    theme_classic(base_size = 14) +
    labs(title = paste0(sample_name, " - Total UMI Distribution"),
         x = "Total UMI count (log10)",
         y = "Number of cells") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  
  # Histogram 2: Genes per cell distribution
  p2 <- ggplot(metadata, aes(x = nFeature_RNA)) +
    geom_histogram(bins = 50, fill = "#2ecc71", color = "black", alpha = 0.7) +
    geom_vline(xintercept = median(metadata$nFeature_RNA), 
               linetype = "dashed", color = "red", size = 1) +
    scale_x_log10() +
    annotation_logticks(sides = "b") +
    theme_classic(base_size = 14) +
    labs(title = paste0(sample_name, " - Genes per Cell Distribution"),
         x = "Number of genes detected (log10)",
         y = "Number of cells") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  
  # Histogram 3: MT% distribution
  p3 <- ggplot(metadata, aes(x = percent.mt)) +
    geom_histogram(bins = 50, fill = "#e74c3c", color = "black", alpha = 0.7) +
    geom_vline(xintercept = median(metadata$percent.mt), 
               linetype = "dashed", color = "darkred", size = 1) +
    theme_classic(base_size = 14) +
    labs(title = paste0(sample_name, " - Mitochondrial %"),
         x = "Mitochondrial gene %",
         y = "Number of cells") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  
  # Histogram 4: Ribosomal% distribution
  p4 <- ggplot(metadata, aes(x = percent.rb)) +
    geom_histogram(bins = 50, fill = "#f39c12", color = "black", alpha = 0.7) +
    geom_vline(xintercept = median(metadata$percent.rb), 
               linetype = "dashed", color = "darkorange", size = 1) +
    theme_classic(base_size = 14) +
    labs(title = paste0(sample_name, " - Ribosomal %"),
         x = "Ribosomal gene %",
         y = "Number of cells") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  
  # Combine
  combined <- (p1 | p2) / (p3 | p4)
  
  return(list(
    total_umi = p1,
    genes_per_cell = p2,
    mito_percent = p3,
    ribo_percent = p4,
    combined = combined
  ))
}

# -----------------------------------------------------------------------------
# Function: Plot QC violin plots
# -----------------------------------------------------------------------------
plot_qc_violins <- function(seurat_obj, sample_name = "Sample") {
  
  cat(paste0("Creating QC violin plots for ", sample_name, "...\n"))
  
  p <- VlnPlot(seurat_obj, 
               features = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb"),
               ncol = 4,
               pt.size = 0.1) & 
    theme(plot.title = element_text(size = 10))
  
  return(p)
}

# -----------------------------------------------------------------------------
# Function: Combined QC summary
# -----------------------------------------------------------------------------

plot_qc_summary <- function(seurat_obj, sample_name = "Sample") {
  
  cat(paste0("\n=== GENERATING QC SUMMARY FOR ", sample_name, " ===\n\n"))
  
  # Get histograms
  histograms <- plot_qc_histograms(seurat_obj, sample_name)
  
  # Get violin plots
  violins <- plot_qc_violins(seurat_obj, sample_name)
  
  # Summary statistics
  metadata <- seurat_obj@meta.data
  
  # Calculate doublet statistics
  if ("doublet_class" %in% colnames(metadata)) {
    n_doublets <- sum(metadata$doublet_class == "doublet")
    n_singlets <- sum(metadata$doublet_class == "singlet")
    doublet_rate <- round(100 * n_doublets / nrow(metadata), 2)
    mean_doublet_score <- round(mean(metadata$doublet_score, na.rm = TRUE), 3)
  } else {
    n_doublets <- NA
    n_singlets <- NA
    doublet_rate <- NA
    mean_doublet_score <- NA
  }
  
  cat("QC Summary Statistics:\n")
  cat(paste0("  Total cells: ", nrow(metadata), "\n"))
  cat(paste0("  Singlets: ", n_singlets, "\n"))
  cat(paste0("  Doublets: ", n_doublets, " (", doublet_rate, "%)\n"))
  cat(paste0("  Mean doublet score: ", mean_doublet_score, "\n"))
  cat(paste0("  Median UMI: ", median(metadata$nCount_RNA), "\n"))
  cat(paste0("  Median genes: ", median(metadata$nFeature_RNA), "\n"))
  cat(paste0("  Median MT%: ", round(median(metadata$percent.mt), 2), "%\n"))
  cat(paste0("  Median Ribo%: ", round(median(metadata$percent.rb), 2), "%\n\n"))
  
  # Create summary data frame
  summary_df <- data.frame(
    Sample = sample_name,
    Total_cells = nrow(metadata),
    Singlets = n_singlets,
    Doublets = n_doublets,
    Doublet_rate_pct = doublet_rate,
    Mean_doublet_score = mean_doublet_score,
    Median_UMI = median(metadata$nCount_RNA),
    Median_genes = median(metadata$nFeature_RNA),
    Median_MT = round(median(metadata$percent.mt), 2),
    Median_Ribo = round(median(metadata$percent.rb), 2),
    stringsAsFactors = FALSE
  )
  
  return(list(
    histograms = histograms,
    violins = violins,
    stats = summary_df
  ))
}

plot_doublet_summary <- function(seurat_obj, sample_name = "Sample") {
  
  cat(paste0("Creating doublet plots for ", sample_name, "...\n"))
  
  metadata <- seurat_obj@meta.data
  
  if (!"doublet_class" %in% colnames(metadata)) {
    cat("  No doublet information found\n")
    return(NULL)
  }
  
  # Plot 1: Doublet class counts
  doublet_counts <- as.data.frame(table(metadata$doublet_class))
  colnames(doublet_counts) <- c("Class", "Count")
  doublet_counts$Percentage <- round(100 * doublet_counts$Count / sum(doublet_counts$Count), 2)
  
  p1 <- ggplot(doublet_counts, aes(x = Class, y = Count, fill = Class)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = paste0(Count, "\n(", Percentage, "%)")), 
              vjust = -0.5, size = 5) +
    scale_fill_manual(values = c("singlet" = "#2ecc71", "doublet" = "#e74c3c")) +
    theme_classic(base_size = 14) +
    labs(
      title = paste0(sample_name, " - Doublet Detection"),
      x = "Classification",
      y = "Number of cells"
    ) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold"),
      legend.position = "none"
    )
  
  # Plot 2: Doublet score distribution
  p2 <- ggplot(metadata, aes(x = doublet_score, fill = doublet_class)) +
    geom_histogram(bins = 50, alpha = 0.7, position = "identity") +
    geom_vline(xintercept = median(metadata$doublet_score[metadata$doublet_class == "doublet"]),
               linetype = "dashed", color = "#e74c3c", size = 1) +
    scale_fill_manual(values = c("singlet" = "#2ecc71", "doublet" = "#e74c3c")) +
    theme_classic(base_size = 14) +
    labs(
      title = paste0(sample_name, " - Doublet Score Distribution"),
      x = "Doublet Score",
      y = "Number of cells",
      fill = "Classification"
    ) +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  
  # Plot 3: Doublet score vs UMI
  p3 <- ggplot(metadata, aes(x = nCount_RNA, y = doublet_score, color = doublet_class)) +
    geom_point(alpha = 0.5, size = 0.5) +
    scale_color_manual(values = c("singlet" = "#2ecc71", "doublet" = "#e74c3c")) +
    scale_x_log10() +
    theme_classic(base_size = 14) +
    labs(
      title = paste0(sample_name, " - Doublet Score vs UMI Count"),
      x = "Total UMI (log10)",
      y = "Doublet Score",
      color = "Classification"
    ) +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  
  # Plot 4: Doublet score vs Genes
  p4 <- ggplot(metadata, aes(x = nFeature_RNA, y = doublet_score, color = doublet_class)) +
    geom_point(alpha = 0.5, size = 0.5) +
    scale_color_manual(values = c("singlet" = "#2ecc71", "doublet" = "#e74c3c")) +
    scale_x_log10() +
    theme_classic(base_size = 14) +
    labs(
      title = paste0(sample_name, " - Doublet Score vs Gene Count"),
      x = "Number of Genes (log10)",
      y = "Doublet Score",
      color = "Classification"
    ) +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  
  # Combine
  combined <- (p1 | p2) / (p3 | p4)
  
  return(list(
    counts = p1,
    score_distribution = p2,
    score_vs_umi = p3,
    score_vs_genes = p4,
    combined = combined
  ))
}
```

# 4. QC metrics and filtering

``````````{r qc_metrics}
cat("\n=== CALCULATING QC METRICS ===\n\n")

# Create Seurat objects
spl_WT_seurat <- CreateSeuratObject(counts = spl_WT, project = "spl_WT")
spl_KO_seurat <- CreateSeuratObject(counts = spl_KO, project = "spl_KO")
bm_WT_seurat <- CreateSeuratObject(counts = bm_WT, project = "bm_WT")
bm_KO_seurat <- CreateSeuratObject(counts = bm_KO, project = "bm_KO")

# Calculate QC metrics
samples <- list(spl_WT_seurat, spl_KO_seurat, bm_WT_seurat, bm_KO_seurat)

for (i in seq_along(samples)) {
  samples[[i]][["percent.mt"]] <- PercentageFeatureSet(samples[[i]], pattern = "^mt-")
  samples[[i]][["percent.rb"]] <- PercentageFeatureSet(samples[[i]], pattern = "^Rp[sl]")
  samples[[i]] <- run_scdblfinder(samples[[i]])
}

# Unpack
spl_WT_seurat <- samples[[1]]
spl_KO_seurat <- samples[[2]]
bm_WT_seurat <- samples[[3]]
bm_KO_seurat <- samples[[4]]

# Plot QC (basic overview)
plot_qc_overview(spl_WT_seurat, "Spleen WT")
plot_qc_overview(spl_KO_seurat, "Spleen KO")
plot_qc_overview(bm_WT_seurat, "Bone Marrow WT")
plot_qc_overview(bm_KO_seurat, "Bone Marrow KO")
``````````

```{r qc_detailed, fig.width=14, fig.height=10}
cat("\n=== DETAILED QC VISUALIZATIONS (BEFORE FILTERING) ===\n\n")

# Create results directory if it doesn't exist
if (!dir.exists("results")) {
  dir.create("results", recursive = TRUE)
  cat("Created results/ directory\n\n")
}

# IMPORTANT: Use objects BEFORE filtering (they still have doublets!)
qc_spl_WT <- plot_qc_summary(spl_WT_seurat, "Spleen WT")
qc_spl_KO <- plot_qc_summary(spl_KO_seurat, "Spleen KO")
qc_bm_WT <- plot_qc_summary(bm_WT_seurat, "Bone Marrow WT")
qc_bm_KO <- plot_qc_summary(bm_KO_seurat, "Bone Marrow KO")

# Display histograms
cat("\n--- QC HISTOGRAMS ---\n")
print(qc_spl_WT$histograms$combined)
print(qc_spl_KO$histograms$combined)
print(qc_bm_WT$histograms$combined)
print(qc_bm_KO$histograms$combined)

# Display violin plots
cat("\n--- QC VIOLIN PLOTS ---\n")
print(qc_spl_WT$violins)
print(qc_spl_KO$violins)
print(qc_bm_WT$violins)
print(qc_bm_KO$violins)

# Generate doublet plots
cat("\n--- DOUBLET ANALYSIS ---\n")
doublet_spl_WT <- plot_doublet_summary(spl_WT_seurat, "Spleen WT")
doublet_spl_KO <- plot_doublet_summary(spl_KO_seurat, "Spleen KO")
doublet_bm_WT <- plot_doublet_summary(bm_WT_seurat, "Bone Marrow WT")
doublet_bm_KO <- plot_doublet_summary(bm_KO_seurat, "Bone Marrow KO")

if (!is.null(doublet_spl_WT)) print(doublet_spl_WT$combined)
if (!is.null(doublet_spl_KO)) print(doublet_spl_KO$combined)
if (!is.null(doublet_bm_WT)) print(doublet_bm_WT$combined)
if (!is.null(doublet_bm_KO)) print(doublet_bm_KO$combined)

# Combine summary statistics
qc_summary_table <- rbind(
  qc_spl_WT$stats,
  qc_spl_KO$stats,
  qc_bm_WT$stats,
  qc_bm_KO$stats
)

cat("\n=== QC SUMMARY TABLE (WITH DOUBLETS) ===\n")
print(qc_summary_table)

# Save summary table
write.csv(qc_summary_table, "results/qc_summary_statistics.csv", row.names = FALSE)

# Create doublet rate comparison plot
doublet_comparison <- qc_summary_table[, c("Sample", "Total_cells", "Singlets", "Doublets", "Doublet_rate_pct")]

cat("\n=== DOUBLET RATE COMPARISON ===\n")
print(doublet_comparison)

p_doublet_comparison <- ggplot(doublet_comparison, aes(x = Sample, y = Doublet_rate_pct, fill = Sample)) +
  geom_bar(stat = "identity") +
  geom_hline(yintercept = 5, linetype = "dashed", color = "red") +
  geom_text(aes(label = paste0(Doublet_rate_pct, "%")), vjust = -0.5, size = 4) +
  scale_fill_brewer(palette = "Set2") +
  theme_classic(base_size = 14) +
  labs(
    title = "Doublet Rate Comparison Across Samples",
    subtitle = "Red line: 5% threshold",
    x = "Sample",
    y = "Doublet Rate (%)"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )

print(p_doublet_comparison)

# Save all QC plots to PDF
pdf("results/qc_detailed_plots.pdf", width = 14, height = 10)

# Histograms
print(qc_spl_WT$histograms$combined)
print(qc_spl_KO$histograms$combined)
print(qc_bm_WT$histograms$combined)
print(qc_bm_KO$histograms$combined)

# Violins
print(qc_spl_WT$violins)
print(qc_spl_KO$violins)
print(qc_bm_WT$violins)
print(qc_bm_KO$violins)

# Doublets
if (!is.null(doublet_spl_WT)) print(doublet_spl_WT$combined)
if (!is.null(doublet_spl_KO)) print(doublet_spl_KO$combined)
if (!is.null(doublet_bm_WT)) print(doublet_bm_WT$combined)
if (!is.null(doublet_bm_KO)) print(doublet_bm_KO$combined)

# Doublet comparison
print(p_doublet_comparison)

dev.off()

cat("\n✓ Detailed QC plots saved to results/qc_detailed_plots.pdf\n")
cat("✓ QC summary statistics saved to results/qc_summary_statistics.csv\n")
```

```{r qc_filtering}
cat("\n=== APPLYING QC FILTERS ===\n\n")
cat("Spleen WT:\n")
spl_WT_seurat <- apply_qc_filtering(spl_WT_seurat)
cat("Spleen KO:\n")
spl_KO_seurat <- apply_qc_filtering(spl_KO_seurat)
cat("Bone Marrow WT:\n")
bm_WT_seurat <- apply_qc_filtering(bm_WT_seurat)
cat("Bone Marrow KO:\n")
bm_KO_seurat <- apply_qc_filtering(bm_KO_seurat)

cat("\n✓ QC filtering complete. Only singlets retained.\n")
```



# 5. Analysis functions

```{r analysis_functions, echo=FALSE}
# =============================================================================
# ALL ANALYSIS FUNCTIONS
# =============================================================================

# -----------------------------------------------------------------------------
# ANNOTATION
# -----------------------------------------------------------------------------

# -----------------------------------------------------------------------------
# ANNOTATION (FIXED FOR SEURAT V5)
# -----------------------------------------------------------------------------

annotate_immune_cells <- function(seurat_obj) {
  
  cat("\n=== CELL TYPE ANNOTATION ===\n")
  cat("Using SingleR with ImmGen reference...\n")
  
  # FIX: Join layers before converting to SCE (Seurat v5)
  DefaultAssay(seurat_obj) <- "RNA"
  if (length(Layers(seurat_obj, assay = "RNA")) > 1) {
    cat("Joining RNA layers for annotation...\n")
    seurat_obj <- JoinLayers(seurat_obj, assay = "RNA")
  }
  
  sce <- as.SingleCellExperiment(seurat_obj)
  immgen_ref <- celldex::ImmGenData()
  
  singler_results <- SingleR(
    test = sce,
    ref = immgen_ref,
    labels = immgen_ref$label.fine
  )
  
  seurat_obj$SingleR_labels <- singler_results$labels
  seurat_obj$SingleR_clean <- gsub("\\s*\\([^\\)]+\\)", "", singler_results$labels)
  seurat_obj$SingleR_confidence <- apply(singler_results$scores, 1, max)
  
  cat(paste0("✓ Identified ", length(unique(seurat_obj$SingleR_clean)), " cell types\n\n"))
  
  return(seurat_obj)
}

# -----------------------------------------------------------------------------
# DIFFERENTIAL EXPRESSION
# -----------------------------------------------------------------------------

find_degs_per_celltype <- function(seurat_obj, celltype_column = "SingleR_clean",
                                    condition_column = "condition", min_cells = 3) {
  
  cat("\n=== DIFFERENTIAL EXPRESSION ANALYSIS ===\n\n")
  
  DefaultAssay(seurat_obj) <- "RNA"
  seurat_obj <- JoinLayers(seurat_obj, assay = "RNA")
  
  cell_types <- unique(seurat_obj@meta.data[[celltype_column]])
  deg_list <- list()
  
  for (ct in cell_types) {
    
    cells_ct <- rownames(seurat_obj@meta.data[seurat_obj@meta.data[[celltype_column]] == ct, ])
    n_wt <- sum(seurat_obj@meta.data[cells_ct, condition_column] == "WT")
    n_ko <- sum(seurat_obj@meta.data[cells_ct, condition_column] == "KO")
    
    if (n_wt < min_cells | n_ko < min_cells) {
      cat(paste0("  Skipping ", ct, " (insufficient cells: WT=", n_wt, ", KO=", n_ko, ")\n"))
      next
    }
    
    cat(paste0("  Analyzing ", ct, " (WT=", n_wt, ", KO=", n_ko, ")...\n"))
    
    seurat_subset <- subset(seurat_obj, cells = cells_ct)
    
    markers <- FindMarkers(seurat_subset,
                           ident.1 = "KO",
                           ident.2 = "WT",
                           group.by = condition_column,
                           min.pct = 0.1,
                           logfc.threshold = 0.25,
                           test.use = "wilcox",
                           verbose = FALSE)
    
    if (nrow(markers) > 0) {
      markers$gene <- rownames(markers)
      markers$cell_type <- ct
      markers$sig <- ifelse(markers$p_val_adj < 0.05, "Significant", "Not Significant")
      
      deg_list[[ct]] <- markers
      
      n_up <- sum(markers$avg_log2FC > 0 & markers$p_val_adj < 0.05)
      n_down <- sum(markers$avg_log2FC < 0 & markers$p_val_adj < 0.05)
      cat(paste0("    Found ", n_up, " upregulated and ", n_down, " downregulated genes\n"))
    }
  }
  
  cat("\n✓ DEG analysis complete\n\n")
  return(deg_list)
}

# -----------------------------------------------------------------------------
# GO ENRICHMENT
# -----------------------------------------------------------------------------

run_go_enrichment <- function(deg_list, pval_cutoff = 0.05, qval_cutoff = 0.2) {
  
  cat("\n=== GENE ONTOLOGY ENRICHMENT ===\n\n")
  
  go_results <- list()
  
  for (ct in names(deg_list)) {
    
    degs <- deg_list[[ct]]
    
    up_genes <- degs$gene[degs$avg_log2FC > 0 & degs$p_val_adj < 0.05]
    down_genes <- degs$gene[degs$avg_log2FC < 0 & degs$p_val_adj < 0.05]
    
    if (length(up_genes) >= 5) {
      cat(paste0("  ", ct, " - Upregulated genes (", length(up_genes), ")...\n"))
      
      go_up <- enrichGO(gene = up_genes,
                        OrgDb = org.Mm.eg.db,
                        keyType = "SYMBOL",
                        ont = "BP",
                        pAdjustMethod = "BH",
                        pvalueCutoff = pval_cutoff,
                        qvalueCutoff = qval_cutoff)
      
      if (!is.null(go_up) && nrow(as.data.frame(go_up)) > 0) {
        go_results[[paste0(ct, "_UP")]] <- go_up
      }
    }
    
    if (length(down_genes) >= 5) {
      cat(paste0("  ", ct, " - Downregulated genes (", length(down_genes), ")...\n"))
      
      go_down <- enrichGO(gene = down_genes,
                          OrgDb = org.Mm.eg.db,
                          keyType = "SYMBOL",
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = pval_cutoff,
                          qvalueCutoff = qval_cutoff)
      
      if (!is.null(go_down) && nrow(as.data.frame(go_down)) > 0) {
        go_results[[paste0(ct, "_DOWN")]] <- go_down
      }
    }
  }
  
  cat("\n✓ GO enrichment complete\n\n")
  return(go_results)
}

# -----------------------------------------------------------------------------
# GSEA
# -----------------------------------------------------------------------------

run_gsea_per_celltype <- function(deg_list, gene_sets = NULL) {
  
  cat("\n=== GENE SET ENRICHMENT ANALYSIS (GSEA) ===\n\n")
  
  if (is.null(gene_sets)) {
    cat("Loading mouse gene sets from MSigDB...\n")
    m_gene_sets <- msigdbr(species = "Mus musculus", category = "H")
    m_go_sets <- msigdbr(species = "Mus musculus", category = "C5", subcategory = "GO:BP")
    gene_sets <- rbind(m_gene_sets, m_go_sets)
  }
  
  pathways <- split(gene_sets$gene_symbol, gene_sets$gs_name)
  gsea_results <- list()
  
  for (ct in names(deg_list)) {
    cat(paste0("Running GSEA for: ", ct, "...\n"))
    
    genes <- deg_list[[ct]]
    genes <- genes[!is.na(genes$avg_log2FC) & !is.na(genes$p_val), ]
    
    genes$rank_metric <- genes$avg_log2FC + 
                         sign(genes$avg_log2FC) * (-log10(genes$p_val + 1e-300)) * 0.001
    
    gene_ranks <- setNames(genes$rank_metric, genes$gene)
    gene_ranks <- sort(gene_ranks, decreasing = TRUE)
    gene_ranks <- gene_ranks[!duplicated(names(gene_ranks))]
    
    tryCatch({
      fgsea_res <- fgsea(
        pathways = pathways,
        stats = gene_ranks,
        minSize = 10,
        maxSize = 500
      )
      
      fgsea_res <- fgsea_res[!is.na(fgsea_res$padj) & fgsea_res$padj < 0.25, ]
      
      if (nrow(fgsea_res) > 0) {
        gsea_results[[ct]] <- fgsea_res
        cat(paste0("  Found ", nrow(fgsea_res), " enriched pathways (padj < 0.25)\n"))
      } else {
        cat("  No significant pathways found\n")
      }
    }, error = function(e) {
      cat(paste0("  Error: ", e$message, "\n"))
    })
  }
  
  cat("\n=== GSEA Complete ===\n\n")
  
  return(gsea_results)
}

plot_gsea_results <- function(gsea_results, top_n = 20) {
  
  plots <- list()
  
  for (ct in names(gsea_results)) {
    
    gsea_df <- gsea_results[[ct]]
    
    if (nrow(gsea_df) == 0) next
    
    gsea_df <- gsea_df[order(abs(gsea_df$NES), decreasing = TRUE), ]
    gsea_df <- head(gsea_df, top_n)
    
    gsea_df$pathway_clean <- gsub("HALLMARK_", "", gsea_df$pathway)
    gsea_df$pathway_clean <- gsub("GOBP_", "", gsea_df$pathway_clean)
    gsea_df$pathway_clean <- gsub("_", " ", gsea_df$pathway_clean)
    gsea_df$pathway_clean <- substr(gsea_df$pathway_clean, 1, 50)
    
    gsea_df$direction <- ifelse(gsea_df$NES > 0, "Upregulated", "Downregulated")
    
    p <- ggplot(gsea_df, aes(x = reorder(pathway_clean, NES), y = NES, fill = direction)) +
      geom_bar(stat = "identity") +
      coord_flip() +
      scale_fill_manual(values = c("Upregulated" = "#e74c3c", "Downregulated" = "#3498db")) +
      theme_classic(base_size = 12) +
      labs(title = paste0("GSEA - ", ct),
           subtitle = paste0("Top ", min(top_n, nrow(gsea_df)), " pathways by |NES|"),
           x = "Pathway",
           y = "Normalized Enrichment Score (NES)",
           fill = "Direction") +
      theme(plot.title = element_text(hjust = 0.5, face = "bold"),
            plot.subtitle = element_text(hjust = 0.5))
    
    plots[[ct]] <- p
  }
  
  return(plots)
}


# =============================================================================
# CACOA FUNCTIONS (COMPLETE - FULLY FIXED)
# =============================================================================

# -----------------------------------------------------------------------------
# Function: Prepare data for cacoa analysis (Seurat v5 compatible)
# -----------------------------------------------------------------------------
prepare_cacoa_data <- function(seurat_obj, 
                                sample_column = "condition",
                                celltype_column = "SingleR_clean") {
  
  cat("\n=== PREPARING DATA FOR CACOA ===\n")
  
  # Create sample groups
  sample_groups <- setNames(
    seurat_obj@meta.data[[sample_column]],
    colnames(seurat_obj)
  )
  
  # Create cell groups (cell types)
  cell_groups <- setNames(
    seurat_obj@meta.data[[celltype_column]],
    colnames(seurat_obj)
  )
  
  # Get expression matrix (use RNA assay)
  DefaultAssay(seurat_obj) <- "RNA"
  
  # Join layers if using Seurat v5
  cat("Joining RNA layers for Seurat v5...\n")
  if (length(Layers(seurat_obj, assay = "RNA")) > 1) {
    seurat_obj <- JoinLayers(seurat_obj, assay = "RNA")
  }
  
  # Get normalized data
  expr_matrix <- GetAssayData(seurat_obj, assay = "RNA", slot = "data")
  
  cat("Data preparation complete.\n")
  
  return(list(
    expr_matrix = expr_matrix,
    sample_groups = sample_groups,
    cell_groups = cell_groups,
    seurat_obj = seurat_obj
  ))
}

# -----------------------------------------------------------------------------
# Function: Create pseudo-replicates for single-sample analysis
# -----------------------------------------------------------------------------
create_pseudo_replicates <- function(seurat_obj, 
                                      condition_column = "condition",
                                      n_pseudo_reps = 3,
                                      seed = 42) {
  
  cat("Creating pseudo-replicates...\n")
  set.seed(seed)
  
  # Get cell names for each condition
  conditions <- unique(seurat_obj@meta.data[[condition_column]])
  
  cell_to_pseudorep <- character(ncol(seurat_obj))
  names(cell_to_pseudorep) <- colnames(seurat_obj)
  
  for (cond in conditions) {
    cells_cond <- colnames(seurat_obj)[seurat_obj@meta.data[[condition_column]] == cond]
    n_cells <- length(cells_cond)
    
    # Randomly assign cells to pseudo-replicates
    pseudo_reps <- sample(1:n_pseudo_reps, n_cells, replace = TRUE)
    cell_to_pseudorep[cells_cond] <- paste0(cond, "_rep", pseudo_reps)
  }
  
  return(cell_to_pseudorep)
}

# -----------------------------------------------------------------------------
# Function: Run cacoa with pseudo-replicates (FIXED)
# -----------------------------------------------------------------------------
run_cacoa_analysis <- function(seurat_obj,
                                sample_column = "condition",
                                celltype_column = "SingleR_clean",
                                ref_level = "WT",
                                target_level = "KO",
                                n_pseudo_reps = 3,
                                n_cores = 1) {
  
  cat("\n=== RUNNING CACOA COMPOSITIONAL ANALYSIS ===\n")
  
  # Prepare data
  cacoa_data <- prepare_cacoa_data(seurat_obj, sample_column, celltype_column)
  seurat_obj <- cacoa_data$seurat_obj
  
  # Create pseudo-replicates
  pseudo_reps <- create_pseudo_replicates(seurat_obj, sample_column, n_pseudo_reps)
  
  # CRITICAL FIX: sample.groups should be CONDITION per PSEUDO-REPLICATE
  unique_pseudo_reps <- unique(pseudo_reps)
  
  # Extract condition from pseudo-replicate name
  sample_groups <- sapply(strsplit(unique_pseudo_reps, "_rep"), `[`, 1)
  names(sample_groups) <- unique_pseudo_reps
  
  # Convert to factor with explicit levels
  sample_groups <- factor(sample_groups, levels = c(ref_level, target_level))
  
  cat(paste0("Created ", length(unique_pseudo_reps), " pseudo-replicates:\n"))
  cat(paste0("  ", ref_level, ": ", sum(sample_groups == ref_level), " replicates\n"))
  cat(paste0("  ", target_level, ": ", sum(sample_groups == target_level), " replicates\n\n"))
  
  # Get embedding (UMAP coordinates)
  embedding <- Embeddings(seurat_obj, reduction = "umap")
  
  # Get graph from Seurat
  DefaultAssay(seurat_obj) <- "integrated"
  graph <- seurat_obj@graphs$integrated_snn
  
  if (!inherits(graph, "dgCMatrix")) {
    graph <- as(graph, "dgCMatrix")
  }
  
  cat("Building cacoa object...\n")
  
  # Build cacoa object
  cao <- Cacoa$new(
    data.object = cacoa_data$expr_matrix,
    cell.groups = cacoa_data$cell_groups,
    sample.groups = sample_groups,
    sample.per.cell = pseudo_reps,
    ref.level = ref_level,
    target.level = target_level,
    graph = graph,
    embedding = embedding,
    n.cores = n_cores,
    verbose = TRUE
  )
  
  cat("Estimating expression shifts...\n")
  cao$estimateExpressionShiftMagnitudes()
  
  cat("Testing compositional differences...\n")
  cao$estimateCellLoadings()
  cao$estimateCellDensity()
  cao$estimateDiffCellDensity(type = "wilcox")
  
  cat("\n=== CACOA Analysis Complete ===\n\n")
  
  return(cao)
}

# -----------------------------------------------------------------------------
# Function: Plot all cacoa results
# -----------------------------------------------------------------------------
plot_cacoa_results <- function(cao, tissue_name = "tissue") {
  
  cat("Generating cacoa plots...\n")
  
  plot_list <- list()
  
  # 1. Cell type abundance changes
  cat("  - Plotting cell type abundance changes...\n")
  tryCatch({
    p1 <- cao$plotCellLoadings(show.pvals = TRUE)
    plot_list$abundance_changes <- p1
  }, error = function(e) {
    cat("    Warning: Could not generate cell loadings plot\n")
  })
  
  # 2. Expression shift magnitudes
  cat("  - Plotting expression shift magnitudes...\n")
  tryCatch({
    p2 <- cao$plotExpressionShiftMagnitudes()
    plot_list$expression_shifts <- p2
  }, error = function(e) {
    cat("    Warning: Could not generate expression shift plot\n")
  })
  
  # 3. Sample-level composition
  cat("  - Plotting sample composition...\n")
  tryCatch({
    cell_counts <- table(cao$cell.groups, cao$sample.per.cell)
    cell_props <- prop.table(cell_counts, margin = 2) * 100
    
    df_props <- as.data.frame(cell_props)
    colnames(df_props) <- c("CellType", "Sample", "Percentage")
    df_props$Condition <- cao$sample.groups[match(df_props$Sample, names(cao$sample.groups))]
    
    p3 <- ggplot(df_props, aes(x = Sample, y = Percentage, fill = CellType)) +
      geom_bar(stat = "identity") +
      theme_classic() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) +
      facet_wrap(~Condition, scales = "free_x") +
      ggtitle(paste0("Cell Type Composition by Sample - ", tissue_name)) +
      ylab("Percentage (%)") +
      xlab("Sample")
    
    plot_list$composition_barplot <- p3
  }, error = function(e) {
    cat("    Warning: Could not generate composition barplot\n")
  })
  
  # 4. Abundance comparison
  cat("  - Creating abundance comparison plot...\n")
  tryCatch({
    cell_type_counts <- table(cao$cell.groups, cao$sample.groups[cao$sample.per.cell])
    cell_type_props <- prop.table(cell_type_counts, margin = 2) * 100
    
    df_abundance <- as.data.frame(cell_type_props)
    colnames(df_abundance) <- c("CellType", "Condition", "Percentage")
    
    p4 <- ggplot(df_abundance, aes(x = CellType, y = Percentage, fill = Condition)) +
      geom_bar(stat = "identity", position = "dodge") +
      theme_classic() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
      scale_fill_manual(values = c("WT" = "#3498db", "KO" = "#e74c3c")) +
      ggtitle(paste0("Cell Type Proportions - ", tissue_name)) +
      ylab("Percentage (%)") +
      xlab("Cell Type")
    
    plot_list$abundance_comparison <- p4
  }, error = function(e) {
    cat("    Warning: Could not generate abundance comparison plot\n")
  })
  
  cat("Plot generation complete.\n\n")
  
  return(plot_list)
}

# -----------------------------------------------------------------------------
# Function: Extract cacoa results as table
# -----------------------------------------------------------------------------
extract_cacoa_results_table <- function(cao) {
  
  cat("\n=== EXTRACTING CACOA RESULTS ===\n")
  
  # Get cell counts and proportions
  cell_counts <- table(cao$cell.groups, cao$sample.groups[cao$sample.per.cell])
  cell_props <- prop.table(cell_counts, margin = 2) * 100
  
  # Calculate statistics
  wt_props <- cell_props[, "WT"]
  ko_props <- cell_props[, "KO"]
  log2fc <- log2((ko_props + 0.01) / (wt_props + 0.01))
  
  # Create results table
  results <- data.frame(
    CellType = names(wt_props),
    WT_percent = as.numeric(wt_props),
    KO_percent = as.numeric(ko_props),
    Difference = as.numeric(ko_props - wt_props),
    log2FC = as.numeric(log2fc),
    stringsAsFactors = FALSE
  )
  
  # Add expression shifts if available
  if (!is.null(cao$test.results$expression.shifts)) {
    expr_shifts_vec <- unlist(cao$test.results$expression.shifts)
    
    # Create data frame with proper matching
    expr_shifts_df <- data.frame(
      CellType = names(expr_shifts_vec),
      ExpressionShift = as.numeric(expr_shifts_vec),
      stringsAsFactors = FALSE
    )
    
    # Merge with left join to keep all cell types
    results <- merge(results, expr_shifts_df, by = "CellType", all.x = TRUE)
    
    cat(paste0("Added expression shifts for ", 
               sum(!is.na(results$ExpressionShift)), " cell types\n"))
  }
  
  # Order by log2FC
  results <- results[order(-results$log2FC), ]
  rownames(results) <- NULL
  
  cat("Results extracted successfully.\n\n")
  
  return(results)
}

# -----------------------------------------------------------------------------
# Function: Export cacoa results
# -----------------------------------------------------------------------------
export_cacoa_results <- function(cao, cacoa_plots, results_table, 
                                  output_dir = "results/cacoa", 
                                  prefix = "spleen") {
  
  # Create output directory
  if (!dir.exists(output_dir)) {
    dir.create(output_dir, recursive = TRUE)
  }
  
  cat(paste0("Exporting cacoa results to ", output_dir, "...\n"))
  
  # 1. Save results table
  write.csv(results_table, 
            file.path(output_dir, paste0(prefix, "_cacoa_results.csv")),
            row.names = FALSE)
  
  # 2. Save expression shifts if available
  if (!is.null(cao$test.results$expression.shifts)) {
    
    # Extract expression shifts correctly
    expr_shifts_list <- cao$test.results$expression.shifts
    
    # Check if it's a named vector or list
    if (is.list(expr_shifts_list)) {
      # If it's a list, extract the mean/single value per cell type
      expr_shifts_vec <- sapply(expr_shifts_list, function(x) {
        if (is.numeric(x) && length(x) == 1) {
          return(x)
        } else if (is.numeric(x) && length(x) > 1) {
          return(mean(x, na.rm = TRUE))
        } else {
          return(NA)
        }
      })
    } else {
      expr_shifts_vec <- expr_shifts_list
    }
    
    # Create data frame
    expr_shifts_df <- data.frame(
      CellType = names(expr_shifts_vec),
      ExpressionShift = as.numeric(expr_shifts_vec),
      stringsAsFactors = FALSE
    )
    
    # Remove NA rows
    expr_shifts_df <- expr_shifts_df[!is.na(expr_shifts_df$ExpressionShift), ]
    
    # Save
    write.csv(expr_shifts_df,
              file.path(output_dir, paste0(prefix, "_expression_shifts.csv")),
              row.names = FALSE)
  }
  
  # 3. Save plots
  pdf(file.path(output_dir, paste0(prefix, "_cacoa_plots.pdf")), 
      width = 12, height = 10)
  
  if (!is.null(cacoa_plots$abundance_changes)) print(cacoa_plots$abundance_changes)
  if (!is.null(cacoa_plots$expression_shifts)) print(cacoa_plots$expression_shifts)
  if (!is.null(cacoa_plots$composition_barplot)) print(cacoa_plots$composition_barplot)
  if (!is.null(cacoa_plots$abundance_comparison)) print(cacoa_plots$abundance_comparison)
  
  dev.off()
  
  # 4. Save cacoa object
  saveRDS(cao, file.path(output_dir, paste0(prefix, "_cacoa_object.rds")))
  
  cat("Export complete.\n\n")
}

# -----------------------------------------------------------------------------
# COMPOSITIONAL ANALYSIS
# -----------------------------------------------------------------------------

run_compositional_analysis <- function(seurat_obj, celltype_column = "SingleR_clean",
                                        condition_column = "condition", min_cells = 10) {
  
  cat("\n=== COMPOSITIONAL ANALYSIS ===\n\n")
  
  count_table <- table(seurat_obj@meta.data[[celltype_column]],
                       seurat_obj@meta.data[[condition_column]])
  
  counts <- as.matrix(count_table)
  
  cell_types <- rownames(counts)[rowSums(counts) >= min_cells]
  counts <- counts[cell_types, ]
  
  cat(paste0("Analyzing ", nrow(counts), " cell types (≥", min_cells, " cells)\n\n"))
  
  counts_for_fisher <- counts[, c("WT", "KO")]
  
  pvals <- apply(counts_for_fisher, 1, function(x) {
    rest_WT <- sum(counts_for_fisher[, "WT"]) - x[1]
    rest_KO <- sum(counts_for_fisher[, "KO"]) - x[2]
    mat <- matrix(c(x[1], x[2], rest_WT, rest_KO), nrow = 2)
    fisher.test(mat)$p.value
  })
  
  props <- prop.table(counts, margin = 2) * 100
  
  results <- data.frame(
    CellType = rownames(counts),
    WT_count = counts[, "WT"],
    KO_count = counts[, "KO"],
    WT_percent = props[, "WT"],
    KO_percent = props[, "KO"],
    log2FC = log2((props[, "KO"] + 0.01) / (props[, "WT"] + 0.01)),
    p_value = pvals,
    p_adj = p.adjust(pvals, method = "BH")
  )
  
  results <- results[order(results$p_adj), ]
  
  cat("\n=== COMPOSITIONAL CHANGES (Fisher's Exact Test) ===\n\n")
  print(results)
  
  sig_changes <- results[results$p_adj < 0.05, ]
  if (nrow(sig_changes) > 0) {
    cat("\n=== SIGNIFICANT CHANGES (adj. p < 0.05) ===\n\n")
    print(sig_changes)
  } else {
    cat("\nNo significant compositional changes detected (adj. p < 0.05)\n")
  }
  
  return(list(results = results, counts = counts))
}

# -----------------------------------------------------------------------------
# COMPOSITIONAL ANALYSIS - ADDITIONAL PLOTS
# -----------------------------------------------------------------------------

plot_significant_foldchanges <- function(comp_results, tissue_name = "tissue", 
                                          padj_cutoff = 0.05) {
  
  results <- comp_results$results
  
  # Filter significant results
  sig_results <- results[results$p_adj < padj_cutoff, ]
  
  if (nrow(sig_results) == 0) {
    cat(paste0("No significant changes found at padj < ", padj_cutoff, "\n"))
    return(NULL)
  }
  
  cat(paste0("Found ", nrow(sig_results), " significant compositional changes\n"))
  
  # Order by log2FC
  sig_results <- sig_results[order(sig_results$log2FC), ]
  sig_results$CellType <- factor(sig_results$CellType, levels = sig_results$CellType)
  
  # Add direction
  sig_results$Direction <- ifelse(sig_results$log2FC > 0, "Increased in KO", "Decreased in KO")
  
  # Plot
  p <- ggplot(sig_results, aes(x = CellType, y = log2FC, fill = Direction)) +
    geom_bar(stat = "identity") +
    geom_hline(yintercept = 0, linetype = "solid", color = "black") +
    coord_flip() +
    scale_fill_manual(values = c("Increased in KO" = "#e74c3c", 
                                  "Decreased in KO" = "#3498db")) +
    theme_classic(base_size = 14) +
    labs(
      title = paste0("Significant Compositional Changes - ", tissue_name),
      subtitle = paste0("(adjusted p < ", padj_cutoff, ")"),
      x = "Cell Type",
      y = "Log2 Fold Change (KO / WT)",
      fill = ""
    ) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
      plot.subtitle = element_text(hjust = 0.5, size = 12),
      legend.position = "top"
    )
  
  return(p)
}

# -----------------------------------------------------------------------------
# COMPOSITIONAL ANALYSIS - PLOTTING (UPDATED WITH ALL PLOTS)
# -----------------------------------------------------------------------------

plot_compositional_results <- function(comp_results, tissue_name = "tissue") {
  
  results <- comp_results$results
  counts <- comp_results$counts
  
  # Plot 1: Stacked bar plot
  counts_long <- reshape2::melt(counts)
  colnames(counts_long) <- c("CellType", "Condition", "Count")
  
  p1 <- ggplot(counts_long, aes(x = Condition, y = Count, fill = CellType)) +
    geom_bar(stat = "identity", position = "fill") +
    scale_y_continuous(labels = scales::percent) +
    theme_classic(base_size = 14) +
    labs(title = paste0("Cell Type Composition - ", tissue_name),
         y = "Proportion") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  
  # Plot 2: Side-by-side comparison
  p2 <- ggplot(counts_long, aes(x = CellType, y = Count, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge") +
    coord_flip() +
    scale_fill_manual(values = c("WT" = "#3498db", "KO" = "#e74c3c")) +
    theme_classic(base_size = 14) +
    labs(title = paste0("Cell Counts - ", tissue_name),
         x = "Cell Type", y = "Count") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  
  # Plot 3: Volcano plot
  results$sig <- ifelse(results$p_adj < 0.05, "Significant", "Not Significant")
  
  p3 <- ggplot(results, aes(x = log2FC, y = -log10(p_adj), color = sig, label = CellType)) +
    geom_point(size = 3, alpha = 0.7) +
    geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "red") +
    geom_vline(xintercept = 0, linetype = "dashed", color = "grey") +
    scale_color_manual(values = c("Significant" = "#e74c3c", "Not Significant" = "grey")) +
    geom_text_repel(data = subset(results, p_adj < 0.05), size = 3) +
    theme_classic(base_size = 14) +
    labs(title = paste0("Compositional Changes - ", tissue_name),
         x = "Log2 Fold Change (KO/WT)",
         y = "-log10(Adjusted p-value)",
         color = "Significance") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  
  # Plot 4: Alluvial plot
  cat("Creating alluvial plot...\n")
  
  props <- prop.table(counts, margin = 2) * 100
  props_df <- as.data.frame(props)
  colnames(props_df) <- c("CellType", "Condition", "Proportion")
  
  n_celltypes <- length(unique(props_df$CellType))
  
  if (n_celltypes <= 12) {
    colors <- RColorBrewer::brewer.pal(min(n_celltypes, 12), "Set3")
  } else {
    colors <- colorRampPalette(RColorBrewer::brewer.pal(12, "Set3"))(n_celltypes)
  }
  names(colors) <- unique(props_df$CellType)
  
  p4 <- ggplot(props_df,
               aes(x = Condition,
                   stratum = CellType,
                   alluvium = CellType,
                   y = Proportion,
                   fill = CellType)) +
    geom_alluvium(alpha = 0.6, knot.pos = 0.4) +
    geom_stratum(alpha = 0.9, color = "grey70", width = 0.3) +
    scale_fill_manual(values = colors, name = "Cell Type") +
    labs(
      x = "",
      y = "Cell Proportion (%)",
      title = paste0("Flow of Cell Type Proportions - ", tissue_name)
    ) +
    theme_minimal(base_size = 14) +
    theme(
      panel.grid = element_blank(),
      axis.text.x = element_text(size = 14, face = "bold"),
      axis.title.y = element_text(size = 14, face = "bold"),
      plot.title = element_text(face = "bold", hjust = 0.5),
      legend.position = "right"
    )
  
  # Plot 5: Significant fold changes barplot (NEW!)
  cat("Creating significant fold changes barplot...\n")
  
  p5 <- plot_significant_foldchanges(comp_results, tissue_name, padj_cutoff = 0.05)
  
  cat("All compositional plots created.\n\n")
  
  return(list(
    barplot = p1, 
    comparison = p2, 
    volcano = p3, 
    alluvial = p4,
    significant_fc = p5  # NEW!
  ))
}

# -----------------------------------------------------------------------------
# EXPORT
# -----------------------------------------------------------------------------

export_tissue_results <- function(seurat_obj, deg_list, go_results, gsea_results,
                                   comp_results, tissue_name = "tissue",
                                   output_dir = "results") {
  
  cat(paste0("\n=== EXPORTING RESULTS - ", tissue_name, " ===\n\n"))
  
  tissue_lower <- tolower(gsub(" ", "", tissue_name))
  tissue_dir <- file.path(output_dir, tissue_lower)
  
  # Create directories
  dir.create(file.path(tissue_dir, "DEG"), recursive = TRUE, showWarnings = FALSE)
  dir.create(file.path(tissue_dir, "GO"), recursive = TRUE, showWarnings = FALSE)
  dir.create(file.path(tissue_dir, "GSEA"), recursive = TRUE, showWarnings = FALSE)
  
  cat("Created directory structure:\n")
  cat(paste0("  ", tissue_dir, "/\n"))
  
  # 1. Export DEG results
  cat("\nExporting DEG results...\n")
  for (ct in names(deg_list)) {
    filename <- paste0("DEG_", gsub("[/ ]", "_", ct), "_KO_vs_WT.csv")
    filepath <- file.path(tissue_dir, "DEG", filename)
    write.csv(deg_list[[ct]], filepath, row.names = FALSE)
    cat(paste0("  Saved: ", filename, "\n"))
  }
  
  # 2. Export GO results
  if (!is.null(go_results) && length(go_results) > 0) {
    cat("\nExporting GO enrichment results...\n")
    for (result_name in names(go_results)) {
      ct_clean <- gsub("[/ ]", "_", result_name)
      filename <- paste0("GO_", ct_clean, ".csv")
      filepath <- file.path(tissue_dir, "GO", filename)
      
      if (class(go_results[[result_name]])[1] == "enrichResult") {
        go_df <- as.data.frame(go_results[[result_name]])
      } else {
        go_df <- go_results[[result_name]]
      }
      
      write.csv(go_df, filepath, row.names = FALSE)
      cat(paste0("  Saved: ", filename, "\n"))
    }
  }
  
  # 3. Export GSEA results (FIXED - handle list columns)
  if (!is.null(gsea_results) && length(gsea_results) > 0) {
    cat("\nExporting GSEA results...\n")
    for (ct in names(gsea_results)) {
      ct_clean <- gsub("[/ ]", "_", ct)
      filename <- paste0("GSEA_", ct_clean, ".csv")
      filepath <- file.path(tissue_dir, "GSEA", filename)
      
      gsea_df <- as.data.frame(gsea_results[[ct]])
      
      # FIX: Convert leadingEdge list to character string
      if ("leadingEdge" %in% colnames(gsea_df)) {
        gsea_df$leadingEdge <- sapply(gsea_df$leadingEdge, function(x) {
          if (is.list(x) || is.character(x)) {
            paste(unlist(x), collapse = ";")
          } else {
            as.character(x)
          }
        })
      }
      
      # Convert any remaining list columns
      list_cols <- sapply(gsea_df, is.list)
      if (any(list_cols)) {
        for (col in names(list_cols)[list_cols]) {
          gsea_df[[col]] <- sapply(gsea_df[[col]], function(x) {
            paste(unlist(x), collapse = ";")
          })
        }
      }
      
      write.csv(gsea_df, filepath, row.names = FALSE)
      cat(paste0("  Saved: ", filename, "\n"))
    }
  }
  
  # 4. Export compositional analysis
  cat("\nExporting compositional analysis...\n")
  comp_file <- file.path(tissue_dir, paste0(tissue_lower, "_compositional_analysis.csv"))
  write.csv(comp_results$results, comp_file, row.names = FALSE)
  cat(paste0("  Saved: ", basename(comp_file), "\n"))
  
  # 5. Save annotated Seurat object
  cat("\nSaving Seurat object...\n")
  seurat_file <- file.path(tissue_dir, paste0(tissue_lower, "_integrated_annotated.rds"))
  saveRDS(seurat_obj, seurat_file)
  cat(paste0("  Saved: ", basename(seurat_file), "\n"))
  
  cat(paste0("\n✓ All ", tissue_name, " results exported to: ", tissue_dir, "/\n\n"))
}
```

# 6. Spleen Analysis
```{r spleen_preprocessing}
cat("\n=== SPLEEN PREPROCESSING ===\n\n")

# Filter for QC pass cells
spl_WT_filtered <- subset(spl_WT_seurat, cells = colnames(spl_WT_seurat)[spl_WT_seurat$doublet_class == "singlet"])
spl_KO_filtered <- subset(spl_KO_seurat, cells = colnames(spl_KO_seurat)[spl_KO_seurat$doublet_class == "singlet"])

# Add condition metadata
spl_WT_filtered$condition <- "WT"
spl_KO_filtered$condition <- "KO"

# Merge
spl_combined <- merge(spl_WT_filtered, spl_KO_filtered, 
                      add.cell.ids = c("WT", "KO"),
                      project = "Spleen")

cat(paste0("Combined spleen dataset: ", ncol(spl_combined), " cells\n\n"))

# Normalize and find variable features
spl_combined <- NormalizeData(spl_combined)
spl_combined <- FindVariableFeatures(spl_combined, nfeatures = 2000)

# Cell cycle scoring

# Convert human cell cycle genes to mouse format (do this once)
s.genes <- cc.genes$s.genes
g2m.genes <- cc.genes$g2m.genes

# Convert to mouse format
s.genes <- str_to_title(tolower(s.genes))
g2m.genes <- str_to_title(tolower(g2m.genes))

s.genes <- intersect(s.genes, rownames(spl_combined))
g2m.genes <- intersect(g2m.genes, rownames(spl_combined))

spl_combined <- CellCycleScoring(spl_combined, 
                                 s.features = s.genes,
                                 g2m.features = g2m.genes)

# Scale with regression
spl_combined <- ScaleData(spl_combined, 
                         vars.to.regress = c("S.Score", "G2M.Score"))

# Integration
spl_list <- SplitObject(spl_combined, split.by = "condition")
spl_anchors <- FindIntegrationAnchors(object.list = spl_list, dims = 1:30)
spl_integrated <- IntegrateData(anchorset = spl_anchors, dims = 1:30)

# PCA, UMAP, Clustering
spl_integrated <- ScaleData(spl_integrated)
spl_integrated <- RunPCA(spl_integrated, npcs = 50)
ElbowPlot(spl_integrated, ndims = 50)
spl_integrated <- RunUMAP(spl_integrated, dims = 1:30)
spl_integrated <- FindNeighbors(spl_integrated, dims = 1:30)
spl_integrated <- FindClusters(spl_integrated, resolution = 0.5)

# Visualize
DimPlot(spl_integrated, group.by = "condition", cols = c("WT" = "#3498db", "KO" = "#e74c3c"))
DimPlot(spl_integrated, label = TRUE)
DimPlot(spl_integrated, group.by = "Phase", split.by = "condition") +
  ggtitle("UMAP after regressing out cell cycle")
```
```{r spleen_annotation}
spl_integrated <- annotate_immune_cells(spl_integrated)

DimPlot(spl_integrated, group.by = "SingleR_clean", label = TRUE, repel = TRUE) +
  ggtitle("Spleen - Cell Type Annotation")
```
```{r spleen_deg}
deg_results_spl <- find_degs_per_celltype(spl_integrated)

# Summary plot
deg_summary <- data.frame(
  CellType = names(deg_results_spl),
  Upregulated = sapply(deg_results_spl, function(x) sum(x$avg_log2FC > 0 & x$p_val_adj < 0.05)),
  Downregulated = sapply(deg_results_spl, function(x) sum(x$avg_log2FC < 0 & x$p_val_adj < 0.05))
)

deg_summary_long <- reshape2::melt(deg_summary, id.vars = "CellType")

ggplot(deg_summary_long, aes(x = CellType, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge") +
  coord_flip() +
  scale_fill_manual(values = c("Upregulated" = "#e74c3c", "Downregulated" = "#3498db")) +
  theme_classic(base_size = 14) +
  labs(title = "DEGs per Cell Type - Spleen",
       x = "Cell Type", y = "Number of DEGs", fill = "Direction")
```
```{r spleen_go}
go_results_spl <- run_go_enrichment(deg_results_spl)

if (length(go_results_spl) > 0) {
  dotplot(go_results_spl[[1]], showCategory = 20, title = names(go_results_spl)[1])
}
```
```{r spleen_gsea, fig.width=12, fig.height=10}
gsea_results_spl <- run_gsea_per_celltype(deg_results_spl)
gsea_plots_spl <- plot_gsea_results(gsea_results_spl, top_n = 20)

if (length(gsea_plots_spl) > 0) {
  print(gsea_plots_spl[[1]])
}
```
```{r spleen_cacoa}
cat("\n=== SPLEEN CACOA ANALYSIS ===\n\n")

# Verify conditions before running
cat("Checking conditions:\n")
print(table(spl_integrated$condition))

# Make sure condition is a factor
spl_integrated$condition <- factor(spl_integrated$condition, levels = c("WT", "KO"))

# Run CACOA
cao_spl <- run_cacoa_analysis(
  seurat_obj = spl_integrated,
  sample_column = "condition",
  celltype_column = "SingleR_clean",
  ref_level = "WT",
  target_level = "KO",
  n_pseudo_reps = 3,
  n_cores = 4
)

# Generate plots
cacoa_plots_spl <- plot_cacoa_results(cao_spl, tissue_name = "Spleen")

# Print main plots
if (!is.null(cacoa_plots_spl$abundance_comparison)) {
  print(cacoa_plots_spl$abundance_comparison)
}

if (!is.null(cacoa_plots_spl$composition_barplot)) {
  print(cacoa_plots_spl$composition_barplot)
}

# Extract results table
cacoa_results_spl <- extract_cacoa_results_table(cao_spl)

# Export all results
export_cacoa_results(
  cao = cao_spl,
  cacoa_plots = cacoa_plots_spl,
  results_table = cacoa_results_spl,
  output_dir = "results/cacoa",
  prefix = "spleen"
)

cat("✓ Spleen CACOA analysis complete\n")
```

```{r spleen_compositional}
comp_results_spl <- run_compositional_analysis(spl_integrated)
comp_plots_spl <- plot_compositional_results(comp_results_spl, "Spleen")

# Display all plots
print(comp_plots_spl$barplot)
print(comp_plots_spl$comparison)
print(comp_plots_spl$volcano)
print(comp_plots_spl$alluvial)

# Display significant fold changes (NEW!)
if (!is.null(comp_plots_spl$significant_fc)) {
  print(comp_plots_spl$significant_fc)
}
```
```{r spleen_export}
cat("\n=== EXPORTING SPLEEN RESULTS ===\n\n")

# Export all results
export_tissue_results(
  seurat_obj = spl_integrated,
  deg_list = deg_results_spl,
  go_results = go_results_spl,
  gsea_results = gsea_results_spl,
  comp_results = comp_results_spl,
  tissue_name = "Spleen",
  output_dir = "results"
)

# Save compositional plots (ALL 5 PLOTS!)
pdf("results/spleen/spleen_compositional_plots.pdf", width = 12, height = 10)
print(comp_plots_spl$barplot)
print(comp_plots_spl$comparison)
print(comp_plots_spl$volcano)
print(comp_plots_spl$alluvial)
if (!is.null(comp_plots_spl$significant_fc)) {
  print(comp_plots_spl$significant_fc)
}
dev.off()

# Save GSEA plots
pdf("results/spleen/spleen_gsea_plots.pdf", width = 12, height = 10)
for (ct in names(gsea_plots_spl)) {
  print(gsea_plots_spl[[ct]])
}
dev.off()

cat("✓ All spleen results exported\n")
```

# 7. Bone marrow analysis

```{r bonemarrow_preprocessing}
cat("\n=== BONE MARROW PREPROCESSING ===\n\n")

# Filter for QC pass cells
bm_WT_filtered <- subset(bm_WT_seurat, cells = colnames(bm_WT_seurat)[bm_WT_seurat$doublet_class == "singlet"])
bm_KO_filtered <- subset(bm_KO_seurat, cells = colnames(bm_KO_seurat)[bm_KO_seurat$doublet_class == "singlet"])

# Add condition metadata
bm_WT_filtered$condition <- "WT"
bm_KO_filtered$condition <- "KO"

# Merge
bm_combined <- merge(bm_WT_filtered, bm_KO_filtered,
                     add.cell.ids = c("WT", "KO"),
                     project = "BoneMarrow")

cat(paste0("Combined bone marrow dataset: ", ncol(bm_combined), " cells\n\n"))

# Normalize and find variable features
bm_combined <- NormalizeData(bm_combined)
bm_combined <- FindVariableFeatures(bm_combined, nfeatures = 2000)

# Cell cycle scoring
bm_combined <- CellCycleScoring(bm_combined,
                                s.features = s.genes,
                                g2m.features = g2m.genes)

# Scale with regression
bm_combined <- ScaleData(bm_combined,
                        vars.to.regress = c("S.Score", "G2M.Score"))

# Integration
bm_list <- SplitObject(bm_combined, split.by = "condition")
bm_anchors <- FindIntegrationAnchors(object.list = bm_list, dims = 1:30)
bm_integrated <- IntegrateData(anchorset = bm_anchors, dims = 1:30)

# PCA, UMAP, Clustering
bm_integrated <- ScaleData(bm_integrated)
bm_integrated <- RunPCA(bm_integrated, npcs = 50)
ElbowPlot(bm_integrated, ndims = 50)
bm_integrated <- RunUMAP(bm_integrated, dims = 1:40)  # Note: 40 dims for BM
bm_integrated <- FindNeighbors(bm_integrated, dims = 1:40)
bm_integrated <- FindClusters(bm_integrated, resolution = 0.5)

# Visualize
DimPlot(bm_integrated, group.by = "condition", cols = c("WT" = "#3498db", "KO" = "#e74c3c"))
DimPlot(bm_integrated, label = TRUE)
DimPlot(bm_integrated, group.by = "Phase", split.by = "condition") +
  ggtitle("UMAP after regressing out cell cycle")
```
```{r bonemarrow_annotation}
bm_integrated <- annotate_immune_cells(bm_integrated)

DimPlot(bm_integrated, group.by = "SingleR_clean", label = TRUE, repel = TRUE) +
  ggtitle("Bone Marrow - Cell Type Annotation")
```
```{r bonemarrow_deg}
deg_results_bm <- find_degs_per_celltype(bm_integrated)

# Summary plot
deg_summary_bm <- data.frame(
  CellType = names(deg_results_bm),
  Upregulated = sapply(deg_results_bm, function(x) sum(x$avg_log2FC > 0 & x$p_val_adj < 0.05)),
  Downregulated = sapply(deg_results_bm, function(x) sum(x$avg_log2FC < 0 & x$p_val_adj < 0.05))
)

deg_summary_bm_long <- reshape2::melt(deg_summary_bm, id.vars = "CellType")

ggplot(deg_summary_bm_long, aes(x = CellType, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge") +
  coord_flip() +
  scale_fill_manual(values = c("Upregulated" = "#e74c3c", "Downregulated" = "#3498db")) +
  theme_classic(base_size = 14) +
  labs(title = "DEGs per Cell Type - Bone Marrow",
       x = "Cell Type", y = "Number of DEGs", fill = "Direction")
```
```{r bonemarrow_go}
go_results_bm <- run_go_enrichment(deg_results_bm)

if (length(go_results_bm) > 0) {
  dotplot(go_results_bm[[1]], showCategory = 20, title = names(go_results_bm)[1])
}
```
```{r bonemarrow_gsea, fig.width=12, fig.height=10}
gsea_results_bm <- run_gsea_per_celltype(deg_results_bm)
gsea_plots_bm <- plot_gsea_results(gsea_results_bm, top_n = 20)

if (length(gsea_plots_bm) > 0) {
  print(gsea_plots_bm[[1]])
}
```
```{r bonemarrow_cacoa}
cat("\n=== BONE MARROW CACOA ANALYSIS ===\n\n")

# Verify conditions before running
cat("Checking conditions:\n")
print(table(bm_integrated$condition))

# Make sure condition is a factor
bm_integrated$condition <- factor(bm_integrated$condition, levels = c("WT", "KO"))

# Run CACOA
cao_bm <- run_cacoa_analysis(
  seurat_obj = bm_integrated,
  sample_column = "condition",
  celltype_column = "SingleR_clean",
  ref_level = "WT",
  target_level = "KO",
  n_pseudo_reps = 3,
  n_cores = 4
)

# Generate plots
cacoa_plots_bm <- plot_cacoa_results(cao_bm, tissue_name = "Bone Marrow")

# Print main plots
if (!is.null(cacoa_plots_bm$abundance_comparison)) {
  print(cacoa_plots_bm$abundance_comparison)
}

if (!is.null(cacoa_plots_bm$composition_barplot)) {
  print(cacoa_plots_bm$composition_barplot)
}

# Extract results table
cacoa_results_bm <- extract_cacoa_results_table(cao_bm)

# Export all results
export_cacoa_results(
  cao = cao_bm,
  cacoa_plots = cacoa_plots_bm,
  results_table = cacoa_results_bm,
  output_dir = "results/cacoa",
  prefix = "bonemarrow"
)

cat("✓ Bone Marrow CACOA analysis complete\n")
```

```{r bonemarrow_compositional}
comp_results_bm <- run_compositional_analysis(bm_integrated)
comp_plots_bm <- plot_compositional_results(comp_results_bm, "Bone Marrow")

# Display all plots
print(comp_plots_bm$barplot)
print(comp_plots_bm$comparison)
print(comp_plots_bm$volcano)
print(comp_plots_bm$alluvial)

# Display significant fold changes (NEW!)
if (!is.null(comp_plots_bm$significant_fc)) {
  print(comp_plots_bm$significant_fc)
}
```
```{r bonemarrow_export}
cat("\n=== EXPORTING BONE MARROW RESULTS ===\n\n")

# Export all results
export_tissue_results(
  seurat_obj = bm_integrated,
  deg_list = deg_results_bm,
  go_results = go_results_bm,
  gsea_results = gsea_results_bm,
  comp_results = comp_results_bm,
  tissue_name = "BoneMarrow",
  output_dir = "results"
)

# Save compositional plots (ALL 5 PLOTS!)
pdf("results/bonemarrow/bonemarrow_compositional_plots.pdf", width = 12, height = 10)
print(comp_plots_bm$barplot)
print(comp_plots_bm$comparison)
print(comp_plots_bm$volcano)
print(comp_plots_bm$alluvial)
if (!is.null(comp_plots_bm$significant_fc)) {
  print(comp_plots_bm$significant_fc)
}
dev.off()

# Save GSEA plots
pdf("results/bonemarrow/bonemarrow_gsea_plots.pdf", width = 12, height = 10)
for (ct in names(gsea_plots_bm)) {
  print(gsea_plots_bm[[ct]])
}
dev.off()

cat("✓ All bone marrow results exported\n")
```

# 8. Tissue Comparison
```{r tissue_comparison}
cat("\n=== TISSUE COMPARISON ===\n\n")

# Find common cell types
common_celltypes <- intersect(names(deg_results_spl), names(deg_results_bm))

cat(paste0("Common cell types between tissues: ", length(common_celltypes), "\n"))
print(common_celltypes)

# Compare DEGs
comparison_list <- list()

for (ct in common_celltypes) {
  
  spl_degs <- deg_results_spl[[ct]]
  bm_degs <- deg_results_bm[[ct]]
  
  common_genes <- intersect(spl_degs$gene, bm_degs$gene)
  
  if (length(common_genes) > 10) {
    
    spl_subset <- spl_degs[spl_degs$gene %in% common_genes, c("gene", "avg_log2FC", "p_val_adj")]
    bm_subset <- bm_degs[bm_degs$gene %in% common_genes, c("gene", "avg_log2FC", "p_val_adj")]
    
    colnames(spl_subset) <- c("gene", "log2FC_Spleen", "padj_Spleen")
    colnames(bm_subset) <- c("gene", "log2FC_BM", "padj_BM")
    
    merged <- merge(spl_subset, bm_subset, by = "gene")
    merged$CellType <- ct
    
    comparison_list[[ct]] <- merged
  }
}

# Combine all comparisons
if (length(comparison_list) > 0) {
  comparison_df <- do.call(rbind, comparison_list)
  
  # Save
  write.csv(comparison_df, "results/spleen_vs_bonemarrow_comparison.csv", row.names = FALSE)
  
  # Plot
  ggplot(comparison_df, aes(x = log2FC_Spleen, y = log2FC_BM)) +
    geom_point(alpha = 0.5) +
    geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
    facet_wrap(~CellType, scales = "free") +
    theme_classic() +
    labs(title = "DEG Comparison: Spleen vs Bone Marrow",
         x = "Log2FC (Spleen)",
         y = "Log2FC (Bone Marrow)")
}
```

# 9. Session Info
```{r session_info}
sessionInfo()
```